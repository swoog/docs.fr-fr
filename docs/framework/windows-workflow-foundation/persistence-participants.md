---
title: Participants de persistance
ms.date: 03/30/2017
ms.assetid: f84d2d5d-1c1b-4f19-be45-65b552d3e9e3
ms.openlocfilehash: f9a1f2142a2aef617c3337bf1bc384a51c8ed049
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/08/2019
ms.locfileid: "59115893"
---
# <a name="persistence-participants"></a><span data-ttu-id="e680f-102">Participants de persistance</span><span class="sxs-lookup"><span data-stu-id="e680f-102">Persistence Participants</span></span>
<span data-ttu-id="e680f-103">Un participant de persistance peut participer à une opération de persistance (enregistrement ou chargement) déclenchée par un hôte d'application.</span><span class="sxs-lookup"><span data-stu-id="e680f-103">A persistence participant can participate in a persistence operation (Save or Load) triggered by an application host.</span></span> <span data-ttu-id="e680f-104">Le [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] est livré avec deux classes abstraites, **PersistenceParticipant** et **PersistenceIOParticipant**, que vous pouvez utiliser pour créer un participant de persistance.</span><span class="sxs-lookup"><span data-stu-id="e680f-104">The [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] ships with two abstract classes, **PersistenceParticipant** and **PersistenceIOParticipant**, which you can use to create a persistence participant.</span></span> <span data-ttu-id="e680f-105">Un participant de persistance dérive de l’une de ces classes, implémente les méthodes qui l’intéressent, puis ajoute une instance de la classe à la collection <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> sur le <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span><span class="sxs-lookup"><span data-stu-id="e680f-105">A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> collection on the <xref:System.ServiceModel.Activities.WorkflowServiceHost> .</span></span> <span data-ttu-id="e680f-106">L’hôte d’application peut rechercher de telles extensions de workflow lorsqu’il rend une instance de workflow persistante et appeler les méthodes appropriées sur les participants de persistance aux moments opportuns.</span><span class="sxs-lookup"><span data-stu-id="e680f-106">The application host may look for such workflow extensions when persisting a workflow instance and invoke appropriate methods on the persistence participants at appropriate times.</span></span>  
  
 <span data-ttu-id="e680f-107">La liste suivante décrit les tâches effectuées par le sous-système de persistance lors des différentes étapes de l’opération de persistance (enregistrement).</span><span class="sxs-lookup"><span data-stu-id="e680f-107">The following list describes the tasks performed by the persistence subsystem in different stages of the Persist (Save) operation.</span></span> <span data-ttu-id="e680f-108">Les participants de persistance sont utilisés durant les troisième et quatrième étapes.</span><span class="sxs-lookup"><span data-stu-id="e680f-108">The persistence participants are used in the third and fourth stages.</span></span> <span data-ttu-id="e680f-109">Si le participant est un participant d’e/s (un participant de persistance qui participe également les opérations d’e/s), le participant est également utilisé dans la sixième étape.</span><span class="sxs-lookup"><span data-stu-id="e680f-109">If the participant is an I/O participant (a persistence participant that also participates in I/O operations), the participant is also used in the sixth stage.</span></span>  
  
1.  <span data-ttu-id="e680f-110">Recueille les valeurs intégrées, notamment l'état du workflow, les signets, les variables mappées et l'horodatage.</span><span class="sxs-lookup"><span data-stu-id="e680f-110">Gathers built-in values, including workflow state, bookmarks, mapped variables, and timestamp.</span></span>  
  
2.  <span data-ttu-id="e680f-111">Recueille tous les participants de persistance ajoutés à la collection d'extensions associée à l'instance de workflow.</span><span class="sxs-lookup"><span data-stu-id="e680f-111">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
3.  <span data-ttu-id="e680f-112">Appelle la méthode <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> implémentée par tous les participants de persistance.</span><span class="sxs-lookup"><span data-stu-id="e680f-112">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method implemented by all persistence participants.</span></span>  
  
4.  <span data-ttu-id="e680f-113">Appelle la méthode <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> implémentée par tous les participants de persistance.</span><span class="sxs-lookup"><span data-stu-id="e680f-113">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method implemented by all persistence participants.</span></span>  
  
5.  <span data-ttu-id="e680f-114">Rend le workflow persistant ou l'enregistre dans le magasin de persistances.</span><span class="sxs-lookup"><span data-stu-id="e680f-114">Persist or save the workflow into the persistence store.</span></span>  
  
6.  <span data-ttu-id="e680f-115">Appelle le <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> méthode sur tous les participants de persistance d’e/s.</span><span class="sxs-lookup"><span data-stu-id="e680f-115">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> method on all of the persistence I/O participants.</span></span> <span data-ttu-id="e680f-116">Si le participant n’est pas un participant d’e/s, cette tâche est ignorée.</span><span class="sxs-lookup"><span data-stu-id="e680f-116">If the participant is not an I/O participant, this task is skipped.</span></span> <span data-ttu-id="e680f-117">Si l'épisode de persistance est transactionnel, la transaction est fournie dans la propriété Transaction.Current.</span><span class="sxs-lookup"><span data-stu-id="e680f-117">If the persistence episode is transactional, the transaction is provided in Transaction.Current property.</span></span>  
  
7.  <span data-ttu-id="e680f-118">Attend que tous les participants de persistance soient terminés.</span><span class="sxs-lookup"><span data-stu-id="e680f-118">Waits for all persistence participants to complete.</span></span> <span data-ttu-id="e680f-119">Si tous les participants réussissent à rendre les données d'instance persistantes, valide la transaction.</span><span class="sxs-lookup"><span data-stu-id="e680f-119">If all the participants succeed in persisting instance data, commits the transaction.</span></span>  
  
 <span data-ttu-id="e680f-120">Un participant de persistance dérive le **PersistenceParticipant** classe et peut implémenter la **CollectValues** et **MapValues** méthodes.</span><span class="sxs-lookup"><span data-stu-id="e680f-120">A persistence participant derives from the **PersistenceParticipant** class and may implement the **CollectValues** and **MapValues** methods.</span></span> <span data-ttu-id="e680f-121">Un participant d’e/s de persistance dérive le **PersistenceIOParticipant** classe et peut implémenter la **BeginOnSave** méthode en plus d’implémenter le **CollectValues**et **MapValues** méthodes.</span><span class="sxs-lookup"><span data-stu-id="e680f-121">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnSave** method in addition to implementing the **CollectValues** and **MapValues** methods.</span></span>  
  
 <span data-ttu-id="e680f-122">Chaque étape est terminée avant que l'étape suivante ne commence.</span><span class="sxs-lookup"><span data-stu-id="e680f-122">Each stage is completed before the next stage begins.</span></span> <span data-ttu-id="e680f-123">Par exemple, les valeurs sont collectées à partir de **tous les** participants de persistance dans la première étape.</span><span class="sxs-lookup"><span data-stu-id="e680f-123">For example, values are collected from **all** persistence participants in the first stage.</span></span> <span data-ttu-id="e680f-124">Toutes les valeurs recueillies dans la première étape sont ensuite fournies à tous les participants de persistance lors de la deuxième étape, en vue de leur mappage.</span><span class="sxs-lookup"><span data-stu-id="e680f-124">Then all the values collected in the first stage are provided to all persistence participants in the second stage for mapping.</span></span> <span data-ttu-id="e680f-125">Puis toutes les valeurs recueillies et mappées lors des première et deuxième étapes sont fournies au fournisseur de persistance durant la troisième étape, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="e680f-125">Then all the values collected and mapped in the first and second stages are provided to the persistence provider in the third stage, and so on.</span></span>  
  
 <span data-ttu-id="e680f-126">La liste suivante décrit les tâches effectuées par le sous-système de persistance lors des différentes étapes de l’opération de chargement.</span><span class="sxs-lookup"><span data-stu-id="e680f-126">The following list describes the tasks performed by the persistence subsystem in different stages of the Load operation.</span></span> <span data-ttu-id="e680f-127">Les participants de persistance sont utilisés lors de la quatrième étape.</span><span class="sxs-lookup"><span data-stu-id="e680f-127">The persistence participants are used in the fourth stage.</span></span> <span data-ttu-id="e680f-128">Les participants d’e/s de persistance (participants de persistance qui participent également les opérations d’e/s) sont également utilisés dans la troisième étape.</span><span class="sxs-lookup"><span data-stu-id="e680f-128">The persistence I/O participants (persistence participants that also participate in I/O operations) are also used in the third stage.</span></span>  
  
1.  <span data-ttu-id="e680f-129">Recueille tous les participants de persistance ajoutés à la collection d'extensions associée à l'instance de workflow.</span><span class="sxs-lookup"><span data-stu-id="e680f-129">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
2.  <span data-ttu-id="e680f-130">Charge le workflow à partir du magasin de persistances.</span><span class="sxs-lookup"><span data-stu-id="e680f-130">Loads the workflow from the persistence store.</span></span>  
  
3.  <span data-ttu-id="e680f-131">Appelle le <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> sur tous les participants de persistance d’e/s et attend que tous les participants de persistance terminer.</span><span class="sxs-lookup"><span data-stu-id="e680f-131">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> on all persistence I/O participants and waits for all the persistence participants to complete.</span></span> <span data-ttu-id="e680f-132">Si l’épisode de persistance est transactionnel, la transaction est fournie dans la propriété Transaction.Current.</span><span class="sxs-lookup"><span data-stu-id="e680f-132">If the persistence episode is transactional, the transaction is provided in Transaction.Current.</span></span>  
  
4.  <span data-ttu-id="e680f-133">Charge l'instance de workflow en mémoire selon les données récupérées dans le magasin de persistances.</span><span class="sxs-lookup"><span data-stu-id="e680f-133">Loads the workflow instance in memory based on the data retrieved from the persistence store.</span></span>  
  
5.  <span data-ttu-id="e680f-134">Appelle la méthode <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> sur chaque participant de persistance.</span><span class="sxs-lookup"><span data-stu-id="e680f-134">Invokes <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> on each persistence participant.</span></span>  
  
 <span data-ttu-id="e680f-135">Un participant de persistance dérive le **PersistenceParticipant** classe et peut implémenter la **PublishValues** (méthode).</span><span class="sxs-lookup"><span data-stu-id="e680f-135">A persistence participant derives from the **PersistenceParticipant** class and may implement the **PublishValues** method.</span></span> <span data-ttu-id="e680f-136">Un participant d’e/s de persistance dérive le **PersistenceIOParticipant** classe et peut implémenter la **BeginOnLoad** méthode en plus d’implémenter le **PublishValues**(méthode).</span><span class="sxs-lookup"><span data-stu-id="e680f-136">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnLoad** method in addition to implementing the **PublishValues** method.</span></span>  
  
 <span data-ttu-id="e680f-137">Lors du chargement d'une instance du workflow, le fournisseur de persistance crée un verrou sur cette instance.</span><span class="sxs-lookup"><span data-stu-id="e680f-137">When loading a workflow instance the persistence provider creates a lock on that instance.</span></span> <span data-ttu-id="e680f-138">Cela empêche l'instance d'être chargée dans plusieurs hôtes dans un scénario multi-nœud.</span><span class="sxs-lookup"><span data-stu-id="e680f-138">This prevents the instance from being loaded by more than one host in a multi-node scenario.</span></span> <span data-ttu-id="e680f-139">Si vous essayez de charger une instance de workflow qui a été verrouillée, vous verrez une exception semblable à ce qui suit : L’exception « System.ServiceModel.Persistence.InstanceLockException : Impossible de terminer l’opération demandée car le verrou par exemple « 00000000-0000-0000-0000-000000000000 » n’a pas pu être acquis. ».</span><span class="sxs-lookup"><span data-stu-id="e680f-139">If you attempt to load a workflow instance that has been locked you will see an exception like the following: The exception " System.ServiceModel.Persistence.InstanceLockException: The requested operation could not complete because the lock for instance '00000000-0000-0000-0000-000000000000' could not be acquired".</span></span> <span data-ttu-id="e680f-140">Cette erreur se produit généralement lorsque l'une des conditions suivantes se vérifie :</span><span class="sxs-lookup"><span data-stu-id="e680f-140">This error is caused when one of the following occurs:</span></span>  
  
-   <span data-ttu-id="e680f-141">Dans un scénario multi-nœud l'instance est chargée par un autre hôte.</span><span class="sxs-lookup"><span data-stu-id="e680f-141">In a multi-node scenario the instance is loaded by another host.</span></span>  <span data-ttu-id="e680f-142">Il existe différentes manières de résoudre ces types de conflits : transférer le traitement au nœud qui possède le verrou et réessayer, ou forcer la charge ce qui empêche l'autre hôte d'enregistrer son travail.</span><span class="sxs-lookup"><span data-stu-id="e680f-142">There are a few different ways to resolve these types of conflicts: forward the processing to the node which owns the lock and retry, or force the load which will cause the other host to be unable to save their work.</span></span>  
  
-   <span data-ttu-id="e680f-143">Dans un scénario à nœud unique et l'hôte est bloqué.</span><span class="sxs-lookup"><span data-stu-id="e680f-143">In a single-node scenario and the host crashed.</span></span>  <span data-ttu-id="e680f-144">Lorsque l'hôte redémarre (recyclage de processus ou création d'une fabrique de fournisseur de persistance), le nouvel hôte tente de charger une instance qui est encore verrouillée par l'ancien hôte, car le verrou n'a pas encore expiré.</span><span class="sxs-lookup"><span data-stu-id="e680f-144">When the host starts up again (a process recycle or creating a new persistence provider factory) the new host attempts to load an instance which is still locked by the old host because the lock hasn't expired yet.</span></span>  
  
-   <span data-ttu-id="e680f-145">Dans un scénario à nœud unique, l'instance en question a été abandonnée à un certain point et une instance de fournisseur de persistance est créée avec un autre ID d'hôte.</span><span class="sxs-lookup"><span data-stu-id="e680f-145">In a single-node scenario and the instance in question was aborted at some point and a new persistence provider instance is created which has a different host ID.</span></span>  
  
 <span data-ttu-id="e680f-146">La valeur d'expiration du verrou est par défaut de cinq minutes, vous pouvez spécifier un délai d'attente différent en appelant <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span><span class="sxs-lookup"><span data-stu-id="e680f-146">The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="e680f-147">Dans cette section</span><span class="sxs-lookup"><span data-stu-id="e680f-147">In This Section</span></span>  
  
-   [<span data-ttu-id="e680f-148">Procédure : créer un participant de persistance personnalisé</span><span class="sxs-lookup"><span data-stu-id="e680f-148">How to: Create a Custom Persistence Participant</span></span>](how-to-create-a-custom-persistence-participant.md)  
  
## <a name="see-also"></a><span data-ttu-id="e680f-149">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="e680f-149">See also</span></span>

- [<span data-ttu-id="e680f-150">Stocker l'extensibilité</span><span class="sxs-lookup"><span data-stu-id="e680f-150">Store Extensibility</span></span>](store-extensibility.md)
